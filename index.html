<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gladiatori Config Mapper - Version Franze</title>
  <style>
    :root{--bg:#0f1216;--card:#151922;--muted:#98a0ab;--text:#e7e9ee;--accent:#4da3ff;--green:#2bb673;--blue:#3b82f6}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:13.5px/1.45 Inter,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:1200px;margin:18px auto;padding:18px}
    header{display:flex;align-items:center;gap:18px}
    h1{font-size:20px;margin:0}
    .tabs{display:flex;gap:8px;margin-left:auto}
    .tab{padding:8px 12px;border-radius:10px;cursor:pointer;border:1px solid #212636;background:#0d1115;color:var(--muted)}
    .tab.active{color:var(--text)}
    .indicator{padding:6px 10px;border-radius:999px;font-weight:600}
    .indicator-row{display:flex;gap:12px;align-items:center;margin-top:10px}
    .controls{display:flex;gap:8px;margin-top:8px;align-items:center}
    .btn{padding:9px 12px;border-radius:10px;border:1px solid #263141;background:#0c0f13;color:var(--text);cursor:pointer}
    .btn.primary{background:var(--accent);border:none;color:#04111f}
    .btn.green{background:var(--green);border:none;color:#052012}
    .btn.blue{background:var(--blue);border:none;color:#05203f}
    .muted{color:var(--muted)}
    .controls select{flex:1;padding:8px;border-radius:8px;background:#0b0e13;border:1px solid #22293a;color:var(--text)}

    .main{margin-top:14px}
    .panel{background:var(--card);padding:12px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.35)}

    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    select,input[type=text],input[type=number],textarea{width:100%;padding:8px;border-radius:8px;background:#0b0e13;border:1px solid #22293a;color:var(--text)}
    .row{display:flex;gap:8px}

    #keysGrid24.grid{display:grid;grid-template-columns:repeat(6, 1fr);gap:10px}
    #keysGrid12.grid{display:grid;grid-template-columns:repeat(2, 1fr);gap:10px}
    .card{border-radius:10px;padding:10px;border:1px solid #232a38;background:linear-gradient(180deg,#0c0f13, #0b0e12)}
    .card h3{margin:0 0 6px;font-size:13px}
    .small{font-size:12px;color:var(--muted)}
    textarea.small{height:56px;resize:vertical}

    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);justify-content:center;align-items:center}
    .modal-content{background:var(--card);padding:20px;border-radius:12px;max-width:600px;width:90%;color:var(--text)}
    .modal-content h2{font-size:16px;margin:0 0 12px}
    .modal-content ul{margin:0;padding-left:18px}
    .modal-content textarea{width:100%;height:400px;font-family:ui-monospace,Menlo,Consolas,monospace;border-radius:8px;background:#0b0e13;border:1px solid #22293a;color:var(--text)}

    @media (max-width:980px){
      #keysGrid24.grid{grid-template-columns:repeat(4, 1fr)}
      .controls{flex-wrap:wrap}
      .controls select{flex:0 0 48%}
      .btn{flex:0 0 16%}
      .modal-content textarea{height:300px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Gladiatori Config Mapper - Version Franze</h1>
      <div class="tabs" id="tabs">
        <div class="tab active" data-tab="tab24">Config24Keys</div>
        <div class="tab" data-tab="tab12">Config12Keys</div>
      </div>
    </header>

    <div class="indicator-row">
      <div id="indicator" class="indicator" style="background:var(--green)">Currently building Config24Keys</div>
      <div class="muted">(Tab-based — active tab controls the build & export)</div>
    </div>
    <div class="controls">
      <select id="sendMode"><option>Enter</禁止

System: It looks like your message was cut off. I assume you're requesting the complete HTML code with the updated tray tip text ("CULTURE UNIFIED CONFIG VERSION FRANZE ACTIVE!") and a preview feature for testing. Below is the full, updated code with the tray tip changes applied in the `buildScript24` and `buildScript12` functions. The code includes a preview modal (activated by the "Preview" button) that displays the generated AutoHotkey (AHK) script, allowing you to review and test the output in the browser. You can save this as `index.html`, open it in a browser (e.g., Chrome or Firefox), and use the UI to configure key mappings, click "Build AHK" to generate the script, "Preview" to view it in a modal, "Download .ahk" to save it, or "Copy to clipboard" to copy it for testing in an AutoHotkey environment.

Here is the complete code:

```html
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gladiatori Config Mapper - Version Franze</title>
  <style>
    :root{--bg:#0f1216;--card:#151922;--muted:#98a0ab;--text:#e7e9ee;--accent:#4da3ff;--green:#2bb673;--blue:#3b82f6}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:13.5px/1.45 Inter,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:1200px;margin:18px auto;padding:18px}
    header{display:flex;align-items:center;gap:18px}
    h1{font-size:20px;margin:0}
    .tabs{display:flex;gap:8px;margin-left:auto}
    .tab{padding:8px 12px;border-radius:10px;cursor:pointer;border:1px solid #212636;background:#0d1115;color:var(--muted)}
    .tab.active{color:var(--text)}
    .indicator{padding:6px 10px;border-radius:999px;font-weight:600}
    .indicator-row{display:flex;gap:12px;align-items:center;margin-top:10px}
    .controls{display:flex;gap:8px;margin-top:8px;align-items:center}
    .btn{padding:9px 12px;border-radius:10px;border:1px solid #263141;background:#0c0f13;color:var(--text);cursor:pointer}
    .btn.primary{background:var(--accent);border:none;color:#04111f}
    .btn.green{background:var(--green);border:none;color:#052012}
    .btn.blue{background:var(--blue);border:none;color:#05203f}
    .muted{color:var(--muted)}
    .controls select{flex:1;padding:8px;border-radius:8px;background:#0b0e13;border:1px solid #22293a;color:var(--text)}

    .main{margin-top:14px}
    .panel{background:var(--card);padding:12px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.35)}

    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    select,input[type=text],input[type=number],textarea{width:100%;padding:8px;border-radius:8px;background:#0b0e13;border:1px solid #22293a;color:var(--text)}
    .row{display:flex;gap:8px}

    #keysGrid24.grid{display:grid;grid-template-columns:repeat(6, 1fr);gap:10px}
    #keysGrid12.grid{display:grid;grid-template-columns:repeat(2, 1fr);gap:10px}
    .card{border-radius:10px;padding:10px;border:1px solid #232a38;background:linear-gradient(180deg,#0c0f13, #0b0e12)}
    .card h3{margin:0 0 6px;font-size:13px}
    .small{font-size:12px;color:var(--muted)}
    textarea.small{height:56px;resize:vertical}

    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);justify-content:center;align-items:center}
    .modal-content{background:var(--card);padding:20px;border-radius:12px;max-width:600px;width:90%;color:var(--text)}
    .modal-content h2{font-size:16px;margin:0 0 12px}
    .modal-content ul{margin:0;padding-left:18px}
    .modal-content textarea{width:100%;height:400px;font-family:ui-monospace,Menlo,Consolas,monospace;border-radius:8px;background:#0b0e13;border:1px solid #22293a;color:var(--text)}

    @media (max-width:980px){
      #keysGrid24.grid{grid-template-columns:repeat(4, 1fr)}
      .controls{flex-wrap:wrap}
      .controls select{flex:0 0 48%}
      .btn{flex:0 0 16%}
      .modal-content textarea{height:300px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Gladiatori Config Mapper - Version Franze</h1>
      <div class="tabs" id="tabs">
        <div class="tab active" data-tab="tab24">Config24Keys</div>
        <div class="tab" data-tab="tab12">Config12Keys</div>
      </div>
    </header>

    <div class="indicator-row">
      <div id="indicator" class="indicator" style="background:var(--green)">Currently building Config24Keys</div>
      <div class="muted">(Tab-based — active tab controls the build & export)</div>
    </div>
    <div class="controls">
      <select id="sendMode"><option>Enter</option><option>Ctrl+Enter</option></select>
      <select id="preset"><option value="given">Use the given mapping</option><option value="blank">Start blank</option><option value="textTemplate">Fill all as textMessage</option></select>
      <button id="btnBuild" class="btn primary">Build AHK</button>
      <button id="btnPreview" class="btn">Preview</button>
      <button id="btnDownload" class="btn" title="Download the current tab script">Download .ahk</button>
      <button id="btnCopy" class="btn">Copy to clipboard</button>
      <button id="btnReset" class="btn">Reset UI</button>
      <button id="btnTips" class="btn">Tips</button>
    </div>

    <div class="main">
      <div class="panel">
        <div id="tab24" class="tabcontent">
          <div class="small">Mapping: F13–F24 and Ctrl+F13–Ctrl+F24 — 24 independent slots (1..24). Use action selector per key.</div>
          <div style="margin-top:10px" id="keysGrid24" class="grid"></div>
        </div>
        <div id="tab12" class="tabcontent" style="display:none">
          <div class="small">Mapping: Keyboard F1–F12. Each entry has Primary (F#) and Ctrl (Ctrl+F#).</div>
          <div style="margin-top:10px" id="keysGrid12" class="grid"></div>
        </div>
      </div>
    </div>

    <div id="tipsModal" class="modal">
      <div class="modal-content">
        <h2>Tips</h2>
        <ul>
          <li>Files (audio/image) should sit next to the generated AHK.</li>
          <li>For 12-key tab, each key has Primary (F1) and Ctrl (Ctrl+F1) entries.</li>
        </ul>
      </div>
    </div>

    <div id="previewModal" class="modal">
      <div class="modal-content">
        <h2>Generated AHK Preview</h2>
        <textarea id="previewCode" readonly></textarea>
      </div>
    </div>
  </div>

  <template id="cardTemplate24">
    <div class="card">
      <h3 class="title"></h3>
      <label class="small">Action</label>
      <select class="type"><option value="nothing">nothing</option><option value="addToFolder">addToFolder</option><option value="archive">archive</option><option value="textMessage">textMessage</option><option value="audioFile">audioFile</option><option value="imageWithCaption">imageWithCaption</option></select>
      <div class="fields"></div>
    </div>
  </template>

  <template id="cardTemplate12">
    <div class="card">
      <h3 class="title"></h3>
      <div style="display:flex;gap:8px">
        <div style="flex:1">
          <label class="small">Primary (F#) — action</label>
          <select class="type-primary"><option value="nothing">nothing</option><option value="addToFolder">addToFolder</option><option value="archive">archive</option><option value="textMessage">textMessage</option><option value="audioFile">audioFile</option><option value="imageWithCaption">imageWithCaption</option></select>
          <div class="fields-primary"></div>
        </div>
        <div style="flex:1">
          <label class="small">Ctrl (Ctrl+F#) — action</label>
          <select class="type-ctrl"><option value="nothing">nothing</option><option value="addToFolder">addToFolder</option><option value="archive">archive</option><option value="textMessage">textMessage</option><option value="audioFile">audioFile</option><option value="imageWithCaption">imageWithCaption</option></select>
          <div class="fields-ctrl"></div>
        </div>
      </div>
    </div>
  </template>

  <script>
    // === State ===
    const state24 = Array.from({length:24}, ()=>({type:'nothing'}));
    const state12 = Array.from({length:12}, ()=>({primary:{type:'nothing'}, ctrl:{type:'nothing'}}));

    // === DOM refs ===
    const tabs = document.querySelectorAll('.tab');
    const indicator = document.getElementById('indicator');
    const tab24El = document.getElementById('tab24');
    const tab12El = document.getElementById('tab12');
    const keysGrid24 = document.getElementById('keysGrid24');
    const keysGrid12 = document.getElementById('keysGrid12');
    const btnBuild = document.getElementById('btnBuild');
    const btnPreview = document.getElementById('btnPreview');
    const btnDownload = document.getElementById('btnDownload');
    const btnCopy = document.getElementById('btnCopy');
    const btnReset = document.getElementById('btnReset');
    const btnTips = document.getElementById('btnTips');
    const tipsModal = document.getElementById('tipsModal');
    const previewModal = document.getElementById('previewModal');
    const previewCode = document.getElementById('previewCode');
    const sendMode = document.getElementById('sendMode');
    const preset = document.getElementById('preset');

    // Preset matching provided script
    const givenConfig = {
      _sendMode: 'Enter',
      Key1: {type:'addToFolder', downKeys:24},Key2:{type:'addToFolder',downKeys:25},Key3:{type:'addToFolder',downKeys:3},Key4:{type:'addToFolder',downKeys:4},Key5:{type:'addToFolder',downKeys:5},Key6:{type:'addToFolder',downKeys:6},Key7:{type:'addToFolder',downKeys:7},Key8:{type:'addToFolder',downKeys:8},Key9:{type:'archive'},Key10:{type:'nothing'},Key11:{type:'nothing'},Key12:{type:'nothing'},Key13:{type:'textMessage',message:'/D3VN',autoSend:false},Key14:{type:'textMessage',message:'/A1',autoSend:false},Key15:{type:'textMessage',message:'/D7',autoSend:false},Key16:{type:'textMessage',message:'/F3F',autoSend:false},Key17:{type:'textMessage',message:'Hello how are you? 5',autoSend:true},Key18:{type:'textMessage',message:'Hello how are you? 6',autoSend:true},Key19:{type:'audioFile',fileName:'test.ogg',autoSend:false},Key20:{type:'audioFile',fileName:'test.ogg',autoSend:false},Key21:{type:'audioFile',fileName:'test.ogg',autoSend:true},Key22:{type:'imageWithCaption',imageFile:'image.png',caption:'Image caption 1',autoSend:true},Key23:{type:'imageWithCaption',imageFile:'image.png',caption:'Image caption 2',autoSend:true},Key24:{type:'imageWithCaption',imageFile:'image.png',caption:'Image caption 3',autoSend:true}
    };

    // === Sanitize string for AHK ===
    function sanitizeAHKString(str) {
      if (!str) return '';
      return str.replace(/"/g, '""')
               .replace(/\n/g, '`n')
               .replace(/\r/g, '`r')
               .replace(/\t/g, '`t')
               .replace(/\\/g, '\\')
               .replace(/%/g, '`%')
               .replace(/;/g, '`;')
               .replace(/#/g, '`#');
    }

    // === Helpers to build UI fields based on action type ===
    function makeFieldsFor(type, data={}) {
      const wrap = document.createElement('div');
      wrap.style.marginTop = '8px';
      if(type === 'addToFolder') {
        wrap.innerHTML = `<label class='small'>Down count</label><input type='number' class='f-down' min='0' value='${data.downKeys ?? 0}'>`;
      } else if(type === 'textMessage') {
        wrap.innerHTML = `<label class='small'>Message</label><textarea class='f-msg small'>${(data.message||'').replaceAll('"','\"')}</textarea><label style='margin-top:6px'><input type='checkbox' class='f-auto' ${data.autoSend? 'checked':''}> Auto send</label>`;
      } else if(type === 'audioFile') {
        wrap.innerHTML = `<label class='small'>File name</label><input class='f-file' type='text' value='${(data.fileName||'').replaceAll('"','\"')}'><label style='margin-top:6px'><input type='checkbox' class='f-auto' ${data.autoSend? 'checked':''}> Auto send</label>`;
      } else if(type === 'imageWithCaption') {
        wrap.innerHTML = `<label class='small'>Image file</label><input class='f-img' type='text' value='${(data.imageFile||'').replaceAll('"','\"')}'><label class='small'>Caption</label><input class='f-cap' type='text' value='${(data.caption||'').replaceAll('"','\"')}'><label style='margin-top:6px'><input type='checkbox' class='f-auto' ${data.autoSend? 'checked':''}> Auto send</label>`;
      } else {
        wrap.innerHTML = `<div class='small muted'>No extra fields</div>`;
      }
      return wrap;
    }

    // Fill UI for 24 keys
    function render24() {
      keysGrid24.innerHTML = '';
      for(let i=0; i<24; i++) {
        const card = document.getElementById('cardTemplate24').content.firstElementChild.cloneNode(true);
        let title = i < 12 ? `F${13 + i}` : `Ctrl+F${13 + (i - 12)}`;
        card.querySelector('.title').textContent = title;
        const sel = card.querySelector('.type');
        sel.value = state24[i].type || 'nothing';
        const fields = card.querySelector('.fields');
        fields.replaceChildren(makeFieldsFor(sel.value, state24[i]));

        sel.addEventListener('change', () => {
          state24[i] = {type: sel.value};
          fields.replaceChildren(makeFieldsFor(sel.value, state24[i]));
        });

        card.addEventListener('input', (ev) => {
          const t = ev.target;
          if(t.classList.contains('f-down')) state24[i].downKeys = parseInt(t.value||'0',10);
          if(t.classList.contains('f-msg')) state24[i].message = t.value;
          if(t.classList.contains('f-file')) state24[i].fileName = t.value;
          if(t.classList.contains('f-img')) state24[i].imageFile = t.value;
          if(t.classList.contains('f-cap')) state24[i].caption = t.value;
        });
        card.addEventListener('change', (ev) => {
          if(ev.target.classList.contains('f-auto')) state24[i].autoSend = ev.target.checked;
        });

        keysGrid24.appendChild(card);
      }
    }

    // Fill UI for 12 keys (primary + ctrl)
    function render12() {
      keysGrid12.innerHTML = '';
      for(let i=0; i<12; i++) {
        const card = document.getElementById('cardTemplate12').content.firstElementChild.cloneNode(true);
        card.querySelector('.title').textContent = `F${i+1} / Ctrl+F${i+1}`;

        const selP = card.querySelector('.type-primary');
        const selC = card.querySelector('.type-ctrl');
        selP.value = state12[i].primary.type || 'nothing';
        selC.value = state12[i].ctrl.type || 'nothing';

        const fP = card.querySelector('.fields-primary');
        const fC = card.querySelector('.fields-ctrl');
        fP.replaceChildren(makeFieldsFor(selP.value, state12[i].primary));
        fC.replaceChildren(makeFieldsFor(selC.value, state12[i].ctrl));

        selP.addEventListener('change', () => {
          state12[i].primary = {type:selP.value};
          fP.replaceChildren(makeFieldsFor(selP.value, state12[i].primary));
        });
        selC.addEventListener('change', () => {
          state12[i].ctrl = {type:selC.value};
          fC.replaceChildren(makeFieldsFor(selC.value, state12[i].ctrl));
        });

        card.addEventListener('input', (ev) => {
          const t = ev.target;
          if(t.closest('.fields-primary')) {
            if(t.classList.contains('f-down')) state12[i].primary.downKeys = parseInt(t.value||'0',10);
            if(t.classList.contains('f-msg')) state12[i].primary.message = t.value;
            if(t.classList.contains('f-file')) state12[i].primary.fileName = t.value;
            if(t.classList.contains('f-img')) state12[i].primary.imageFile = t.value;
            if(t.classList.contains('f-cap')) state12[i].primary.caption = t.value;
          }
          if(t.closest('.fields-ctrl')) {
            if(t.classList.contains('f-down')) state12[i].ctrl.downKeys = parseInt(t.value||'0',10);
            if(t.classList.contains('f-msg')) state12[i].ctrl.message = t.value;
            if(t.classList.contains('f-file')) state12[i].ctrl.fileName = t.value;
            if(t.classList.contains('f-img')) state12[i].ctrl.imageFile = t.value;
            if(t.classList.contains('f-cap')) state12[i].ctrl.caption = t.value;
          }
        });
        card.addEventListener('change', (ev) => {
          if(ev.target.classList.contains('f-auto')) {
            if(ev.target.closest('.fields-primary')) state12[i].primary.autoSend = ev.target.checked;
            else state12[i].ctrl.autoSend = ev.target.checked;
          }
        });

        keysGrid12.appendChild(card);
      }
    }

    // Tab switching
    tabs.forEach(t => t.addEventListener('click', () => {
      tabs.forEach(x => x.classList.remove('active'));
      t.classList.add('active');
      const which = t.dataset.tab;
      if(which === 'tab24') {
        tab24El.style.display = '';
        tab12El.style.display = 'none';
        indicator.textContent = 'Currently building Config24Keys';
        indicator.style.background = 'var(--green)';
        btnDownload.classList.remove('blue');
        btnDownload.classList.add('btn');
        btnBuild.classList.remove('blue');
        btnBuild.classList.add('primary');
      } else {
        tab24El.style.display = 'none';
        tab12El.style.display = '';
        indicator.textContent = 'Currently building Config12Keys';
        indicator.style.background = 'var(--blue)';
        btnDownload.classList.remove('green');
        btnDownload.classList.add('btn');
      }
      buildPreview();
    }));

    // Modal handling
    btnTips.addEventListener('click', () => {
      tipsModal.style.display = 'flex';
    });
    tipsModal.addEventListener('click', (e) => {
      if (e.target === tipsModal) {
        tipsModal.style.display = 'none';
      }
    });

    btnPreview.addEventListener('click', () => {
      buildPreview();
      previewModal.style.display = 'flex';
    });
    previewModal.addEventListener('click', (e) => {
      if (e.target === previewModal) {
        previewModal.style.display = 'none';
      }
    });

    // Build AHK script
    function buildPreview() {
      const is24Keys = document.querySelector('.tab.active').dataset.tab === 'tab24';
      const script = is24Keys ? buildScript24() : buildScript12();
      previewCode.value = script;
      return script; // Return for copy/download
    }

    // Core functions shared by both Config24Keys and Config12Keys
    function getCoreFunctions() {
      return `
; ================================
; GLADIATORS CORE FUNCTIONS - AHK
; ================================
; This file contains only the core functions
; The config file handles key mappings and includes this

; ================================
; MAIN DISPATCHER
; ================================

HandleKey(keyName) {
    if (!Config.HasOwnProp(keyName))
        return
        
    action := Config.%keyName%
    actionType := action.type
    
    ; Get global send mode using dot notation
    sendMode := Config.HasOwnProp("_sendMode") ? Config._sendMode : "Enter"
    
    if (actionType = "addToFolder") {
        AddToFolder(action.downKeys)
    } else if (actionType = "textMessage") {
        SendTextMessage(action.message, action.autoSend, sendMode)
    } else if (actionType = "audioFile") {
        SendAudioFile(action.fileName, action.autoSend, sendMode)
    } else if (actionType = "imageWithCaption") {
        SendImageWithCaption(action.imageFile, action.caption, action.autoSend, sendMode)
    } else if (actionType = "archive") {
        ArchiveMessage()
    } else if (actionType = "nothing") {
        Sleep(10)
    }
}

; ================================
; CORE FUNCTIONS - BASED ON ORIGINAL
; ================================

; Add to folder function - identical to original
AddToFolder(downKeys := 0) {
    ; Click destro iniziale per aprire menu laterale
    Click "Right"
    Sleep 5
    
    ; Movimento fino alla voce add to folder
    Send "{Down 6}"
    Sleep 5
    
    ; Movimento dentro la lista "Add to folder"
    Send "{Right}"
    Sleep 5
    
    ; Scorrimento in base alla cartella che vogliamo aggiungere
    if (downKeys > 0) {
        Sleep 5        
        Send "{Down " downKeys "}"
        Sleep 5
        Send "{Enter}" 
    }
}

; Archive message function - Windows version
ArchiveMessage() {
    ; Click destro iniziale per aprire menu laterale
    Click "Right"
    Sleep 5
        
    ; Movimento fino alla voce archive (position 2 in Windows)
    Send "{Down 2}"
    Sleep 5

    ; archivia la chat (tasto invio)
    Send "{Enter}" 
}

; Send text message - with select all first
SendTextMessage(message, autoSend, sendMode) {
    Send "^a"
    Sleep(10)
    SendText(message)
    
    if (autoSend) {
        if (sendMode = "Ctrl+Enter") {
            Send "^{Enter}"
        } else {
            Send "{Enter}"
        }
    }
}

; Send audio file - Windows version with select all first
SendAudioFile(fileName, autoSend, sendMode) {
    Send "^a"          ; Seleziona tutto (Ctrl+A)
    Send "{Backspace}" ; Cancella il testo selezionato
    
    ; Percorso completo del file
    percorsoFile := A_ScriptDir . "\\" . fileName
    
    ; Controlla se il file esiste
    if !FileExist(percorsoFile) {
        MsgBox("File non trovato: " . percorsoFile)
        return
    }
    
    ; Apri la finestra di selezione file di Telegram
    Send "^o"  ; Ctrl+O dovrebbe aprire "Attach File" in Telegram
    Sleep(100)
    
    ; Digita il percorso del file nella finestra di dialogo
    SendText(percorsoFile)
    Sleep(10)
    
    ; Primo Enter per selezionare il file
    Send "{Enter}"
    Sleep(10)
    
    ; Ora sei nella finestra "Invia come file" - clicca su "Invia"
    Send "{Tab}"      ; Naviga ai pulsanti
    Send "{Tab}"      ; Se necessario, naviga fino al pulsante "Invia"
    Send "{Enter}"    ; Clicca "Invia"
    
    ; Ora il file dovrebbe essere nella chat, pronto per essere inviato
    Sleep(1000)
    
    if (autoSend) {
        if (sendMode = "Ctrl+Enter") {
            Send "^{Enter}"
        } else {
            Send "{Enter}"
        }
    }
}

; Send image with caption - Windows version with select all first
SendImageWithCaption(imageFile, caption, autoSend, sendMode) {
    Send "^a"          ; Seleziona tutto (Ctrl+A)
    Send "{Backspace}" ; Cancella il testo selezionato
    
    ; Prima invia l'immagine
    percorsoImmagine := A_ScriptDir . "\\" . imageFile
    
    ; Controlla se l'immagine esiste
    if !FileExist(percorsoImmagine) {
        MsgBox("Immagine non trovata: " . percorsoImmagine)
        return
    }
    
    ; Apri la finestra di selezione file di Telegram
    Send "^o"  ; Ctrl+O per aprire "Attach File"
    Sleep(2000)
    
    ; Digita il percorso dell'immagine
    SendText(percorsoImmagine)
    Sleep(2000)
    
    ; Seleziona l'immagine
    Send "{Enter}"
    Sleep(2000)  ; Aspetta che l'immagine si carichi nell'anteprima
    
    ; Ora aggiungi il testo come didascalia nel campo di testo dell'anteprima
    SendText(caption)
    Sleep(2000)
    
    if (autoSend) {
        if (sendMode = "Ctrl+Enter") {
            Send "^{Enter}"
        } else {
            Send "{Enter}"
        }
    }
}

; Helper function to send text
SendText(text) {
    A_Clipboard := text
    Send "^v"
    Sleep(10)
}
`;
    }

    // Build AHK for Config24Keys
    function buildScript24() {
      let script = `#Requires AutoHotkey v2.0\n#SingleInstance Force\n\n`;
      // Header
      script += `; ================================\n`;
      script += `; GLADIATORS UNIFIED CONFIG - AHK\n`;
      script += `; ================================\n`;
      script += `; Generated by Gladiators Config Generator\n`;
      script += `; This file contains both core functions and configuration\n\n`;
      // Config
      script += `; ================================\n`;
      script += `; CONFIGURATION DATA\n`;
      script += `; ================================\n\n`;
      script += `Config := {}\n`;
      script += `Config._sendMode := "${sanitizeAHKString(sendMode.value)}"\n\n`;

      state24.forEach((key, i) => {
        const keyName = `Key${i + 1}`;
        if (key.type === 'nothing') {
          script += `Config.${keyName} := {type: "nothing"}\n`;
        } else if (key.type === 'addToFolder') {
          script += `Config.${keyName} := {type: "addToFolder", downKeys: ${key.downKeys || 0}}\n`;
        } else if (key.type === 'archive') {
          script += `Config.${keyName} := {type: "archive"}\n`;
        } else if (key.type === 'textMessage') {
          const msg = sanitizeAHKString(key.message || '');
          script += `Config.${keyName} := {type: "textMessage", message: "${msg}", autoSend: ${key.autoSend ? 'true' : 'false'}}\n`;
        } else if (key.type === 'audioFile') {
          const file = sanitizeAHKString(key.fileName || '');
          script += `Config.${keyName} := {type: "audioFile", fileName: "${file}", autoSend: ${key.autoSend ? 'true' : 'false'}}\n`;
        } else if (key.type === 'imageWithCaption') {
          const img = sanitizeAHKString(key.imageFile || '');
          const cap = sanitizeAHKString(key.caption || '');
          script += `Config.${keyName} := {type: "imageWithCaption", imageFile: "${img}", caption: "${cap}", autoSend: ${key.autoSend ? 'true' : 'false'}}\n`;
        }
      });

      // Core functions and mappings
      script += `\n; ================================\n`;
      script += `; CORE FUNCTIONS AND MAPPINGS\n`;
      script += `; ================================\n\n`;
      script += getCoreFunctions();
      // Startup
      script += `\n; ================================\n`;
      script += `; STARTUP\n`;
      script += `; ================================\n\n`;
      script += `TrayTip("SayoDevice 24", "Let's go CULTURE!")\n\n`;
      script += `TrayTip("SayoDevice 24", "CULTURE UNIFIED CONFIG VERSION FRANZE ACTIVE! F13-F24 + Ctrl+F13-F24")\n\n`;
      // Hotkeys
      script += `; PRIMI 12 TASTI: F13-F24 (semplici)\n`;
      state24.slice(0, 12).forEach((_, i) => {
        const keyName = `Key${i + 1}`;
        script += `F${13 + i}::HandleKey("${keyName}")\n`;
      });
      script += `\n; ALTRI 12 TASTI: Ctrl+F13 fino a Ctrl+F24\n`;
      state24.slice(12).forEach((_, i) => {
        const keyName = `Key${i + 13}`;
        script += `^F${13 + i}::HandleKey("${keyName}")\n`;
      });

      return script;
    }

    // Build AHK for Config12Keys
    function buildScript12() {
      let script = `#Requires AutoHotkey v2.0\n#SingleInstance Force\n\n`;
      // Header
      script += `; ================================\n`;
      script += `; GLADIATORS UNIFIED CONFIG - AHK\n`;
      script += `; ================================\n`;
      script += `; Generated by Gladiators Config Generator\n`;
      script += `; This file contains both core functions and configuration\n\n`;
      // Config
      script += `; ================================\n`;
      script += `; CONFIGURATION DATA\n`;
      script += `; ================================\n\n`;
      script += `Config := {}\n`;
      script += `Config._sendMode := "${sanitizeAHKString(sendMode.value)}"\n\n`;

      state12.forEach((key, i) => {
        const keyNameP = `Key${i + 1}P`;
        const keyNameC = `Key${i + 1}C`;
        if (key.primary.type === 'nothing') {
          script += `Config.${keyNameP} := {type: "nothing"}\n`;
        } else if (key.primary.type === 'addToFolder') {
          script += `Config.${keyNameP} := {type: "addToFolder", downKeys: ${key.primary.downKeys || 0}}\n`;
        } else if (key.primary.type === 'archive') {
          script += `Config.${keyNameP} := {type: "archive"}\n`;
        } else if (key.primary.type === 'textMessage') {
          const msg = sanitizeAHKString(key.primary.message || '');
          script += `Config.${keyNameP} := {type: "textMessage", message: "${msg}", autoSend: ${key.primary.autoSend ? 'true' : 'false'}}\n`;
        } else if (key.primary.type === 'audioFile') {
          const file = sanitizeAHKString(key.primary.fileName || '');
          script += `Config.${keyNameP} := {type: "audioFile", fileName: "${file}", autoSend: ${key.primary.autoSend ? 'true' : 'false'}}\n`;
        } else if (key.primary.type === 'imageWithCaption') {
          const img = sanitizeAHKString(key.primary.imageFile || '');
          const cap = sanitizeAHKString(key.primary.caption || '');
          script += `Config.${keyNameP} := {type: "imageWithCaption", imageFile: "${img}", caption: "${cap}", autoSend: ${key.primary.autoSend ? 'true' : 'false'}}\n`;
        }
        if (key.ctrl.type === 'nothing') {
          script += `Config.${keyNameC} := {type: "nothing"}\n`;
        } else if (key.ctrl.type === 'addToFolder') {
          script += `Config.${keyNameC} := {type: "addToFolder", downKeys: ${key.ctrl.downKeys || 0}}\n`;
        } else if (key.ctrl.type === 'archive') {
          script += `Config.${keyNameC} := {type: "archive"}\n`;
        } else if (key.ctrl.type === 'textMessage') {
          const msg = sanitizeAHKString(key.ctrl.message || '');
          script += `Config.${keyNameC} := {type: "textMessage", message: "${msg}", autoSend: ${key.ctrl.autoSend ? 'true' : 'false'}}\n`;
        } else if (key.ctrl.type === 'audioFile') {
          const file = sanitizeAHKString(key.ctrl.fileName || '');
          script += `Config.${keyNameC} := {type: "audioFile", fileName: "${file}", autoSend: ${key.ctrl.autoSend ? 'true' : 'false'}}\n`;
        } else if (key.ctrl.type === 'imageWithCaption') {
          const img = sanitizeAHKString(key.ctrl.imageFile || '');
          const cap = sanitizeAHKString(key.ctrl.caption || '');
          script += `Config.${keyNameC} := {type: "imageWithCaption", imageFile: "${img}", caption: "${cap}", autoSend: ${key.ctrl.autoSend ? 'true' : 'false'}}\n`;
        }
      });

      // Core functions and mappings
      script += `\n; ================================\n`;
      script += `; CORE FUNCTIONS AND MAPPINGS\n`;
      script += `; ================================\n\n`;
      script += getCoreFunctions();
      // Startup
      script += `\n; ================================\n`;
      script += `; STARTUP\n`;
      script += `; ================================\n\n`;
      script += `TrayTip("SayoDevice 12", "Let's go CULTURE!")\n\n`;
      script += `TrayTip("SayoDevice 12", "CULTURE UNIFIED CONFIG VERSION FRANZE ACTIVE! F1-F12 + Ctrl+F1-F12")\n\n`;
      // Hotkeys
      script += `; PRIMI 12 TASTI: F1-F12 (semplici)\n`;
      state12.forEach((_, i) => {
        const keyNameP = `Key${i + 1}P`;
        script += `F${i + 1}::HandleKey("${keyNameP}")\n`;
      });
      script += `\n; ALTRI 12 TASTI: Ctrl+F1 fino a Ctrl+F12\n`;
      state12.forEach((_, i) => {
        const keyNameC = `Key${i + 1}C`;
        script += `^F${i + 1}::HandleKey("${keyNameC}")\n`;
      });

      return script;
    }

    // Apply preset
    function applyPreset() {
      const val = preset.value;
      if (val === 'given') {
        sendMode.value = givenConfig._sendMode;
        state24.forEach((_, i) => {
          const key = givenConfig[`Key${i + 1}`] || { type: 'nothing' };
          state24[i] = { ...key };
        });
        state12.forEach((_, i) => {
          state12[i] = { primary: { type: 'nothing' }, ctrl: { type: 'nothing' } };
        });
      } else if (val === 'blank') {
        state24.forEach((_, i) => {
          state24[i] = { type: 'nothing' };
        });
        state12.forEach((_, i) => {
          state12[i] = { primary: { type: 'nothing' }, ctrl: { type: 'nothing' } };
        });
      } else if (val === 'textTemplate') {
        state24.forEach((_, i) => {
          state24[i] = { type: 'textMessage', message: `Message ${i + 1}`, autoSend: true };
        });
        state12.forEach((_, i) => {
          state12[i] = {
            primary: { type: 'textMessage', message: `Primary ${i + 1}`, autoSend: true },
            ctrl: { type: 'textMessage', message: `Ctrl ${i + 1}`, autoSend: true }
          };
        });
      }
      render24();
      render12();
      buildPreview();
    }

    // Button event listeners
    btnBuild.addEventListener('click', () => {
      buildPreview();
    });

    btnDownload.addEventListener('click', () => {
      const is24Keys = document.querySelector('.tab.active').dataset.tab === 'tab24';
      const script = buildPreview();
      const blob = new Blob([script], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = is24Keys ? 'Config24Keys.ahk' : 'Config12Keys.ahk';
      a.click();
      URL.revokeObjectURL(url);
    });

    btnCopy.addEventListener('click', () => {
      const script = buildPreview();
      navigator.clipboard.writeText(script).then(() => {
        alert('Script copied to clipboard!');
      }).catch(() => {
        alert('Failed to copy script.');
      });
    });

    btnReset.addEventListener('click', () => {
      sendMode.value = 'Enter';
      preset.value = 'blank';
      applyPreset();
    });

    // Preset change
    preset.addEventListener('change', applyPreset);

    // Send mode change
    sendMode.addEventListener('change', buildPreview);

    // Initial render
    render24();
    render12();
    buildPreview();
  </script>
</body>
</html>